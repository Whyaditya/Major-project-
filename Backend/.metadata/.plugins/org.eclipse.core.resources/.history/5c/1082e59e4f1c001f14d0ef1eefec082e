package com.propertypal.backend.service;

import com.propertypal.backend.model.User;
import com.propertypal.backend.model.Flat;
import com.propertypal.backend.model.Bungalow;
import com.propertypal.backend.model.UserInterest;
import com.propertypal.backend.repository.UserRepository;
import com.propertypal.backend.repository.FlatRepository;
import com.propertypal.backend.repository.BungalowRepository;
import com.propertypal.backend.repository.UserInterestRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

@Service
public class UserInterestServiceImpl implements UserInterestService {

    private final UserInterestRepository userInterestRepository;
    private final UserRepository userRepository;
    private final FlatRepository flatRepository;
    private final BungalowRepository bungalowRepository;

    @Autowired
    public UserInterestServiceImpl(UserInterestRepository userInterestRepository, 
                                   UserRepository userRepository,
                                   FlatRepository flatRepository,
                                   BungalowRepository bungalowRepository) {
        this.userInterestRepository = userInterestRepository;
        this.userRepository = userRepository;
        this.flatRepository = flatRepository;
        this.bungalowRepository = bungalowRepository;
    }

    @Override
    public UserInterest addInterest(Long userId, Long flatId, Long bungalowId) {
        Optional<User> userOptional = userRepository.findById(userId);
        if (!userOptional.isPresent()) {
            // Handle the case where the user is not found
            throw new IllegalArgumentException("User not found");
        }

        User user = userOptional.get();
        Flat flat = null;
        Bungalow bungalow = null;

        if (flatId != null) {
            Optional<Flat> flatOptional = flatRepository.findById(flatId);
            if (!flatOptional.isPresent()) {
                // Handle the case where the flat is not found
                throw new IllegalArgumentException("Flat not found");
            }
            flat = flatOptional.get();
        } else if (bungalowId != null) {
            Optional<Bungalow> bungalowOptional = bungalowRepository.findById(bungalowId);
            if (!bungalowOptional.isPresent()) {
                // Handle the case where the bungalow is not found
                throw new IllegalArgumentException("Bungalow not found");
            }
            bungalow = bungalowOptional.get();
        }

        UserInterest interest = new UserInterest();
        interest.setUser(user);
        interest.setFlat(flat);
        interest.setBungalow(bungalow);

        return userInterestRepository.save(interest);
    }

    @Override
    public List<UserInterest> getUserInterests(Long userId) {
        return userInterestRepository.findByUserId(userId);
    }

    @Override
    public void deleteInterest(Long interestId) {
        userInterestRepository.deleteById(interestId);
    }

    @Override
    public boolean isPropertyInterestedByUser(Long userId, Long propertyId) {
        return userInterestRepository.existsByUserIdAndPropertyId(userId, propertyId);
    }
}
